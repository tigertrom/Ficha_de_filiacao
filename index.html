<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Filiação</title>
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #001132;
            color: white;
            text-align: left;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid white;
            border-radius: 10px;
            background-color: #003399;
            box-sizing: border-box;
        }
        .dependente-container {
            width: 90%;
            max-width: 550px;
            margin: 10px auto;
            padding: 10px;
            border: 1px solid white;
            border-radius: 10px;
            background-color: #003399;
            box-sizing: border-box;
        }
        .assinatura-container {
            width: 90%;
            max-width: 550px;
            margin: 10px auto;
            padding: 10px;
            border: 1px solid white;
            border-radius: 10px;
            background-color: #003399;
            box-sizing: border-box;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header img {
            width: 30%;
            max-width: 150px;
        }
        .header h1 {
            margin-top: 10px;
        }
        input[type="text"], input[type="file"], input[type="date"], textarea, select {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            box-sizing: border-box;
        }
        #signature {
            border: 1px solid white;
            height: 200px;
            margin-bottom: 10px;
            position: relative;
            box-sizing: border-box;
        }
        #signature canvas {
            border: 1px solid white;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.7/inputmask.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="img/logo.png" alt="Logo">
            <h1><span style="color: yellow; font-size: 35px;">Ficha de filiação</span></h1>
        </div>
        <form id="expenseForm">
            <!-- Campos do formulário -->
            <label for="nome">Nome Completo:</label>
            <input type="text" id="nome" name="nome" required>
            <label for="rf">RF:</label>
            <input type="text" id="rf" name="rf" required>
            <label for="cpf">CPF:</label>
            <input type="text" id="cpf" name="cpf" required>
            <label for="cargo">Cargo:</label>
            <select id="cargo" name="cargo" required>
                <option value="selecionecargo"> </option>
                <option value="3classe">3ª Classe</option>
                <option value="2classe">2ª Classe</option>
                <option value="1classe">1ª Classe</option>
                <option value="ce">Classe Especial</option>
                <option value="cd">Classe Distinta</option>
                <option value="sub">Subinspetor</option>
                <option value="insp-divisao">Inspetor de Divisão</option>
                <option value="insp-agrup">Inspetor de Agrupamento</option>
                <option value="insp-superintendente">Inspetor Superintendente</option>
            </select>
            <label for="sexo">Sexo:</label>
            <select id="sexo" name="sexo" required>
                <option value="selecionesexo"> </option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
                <option value="outros">prefiro não declarar</option>
            </select><br><br>
            <label for="celular">Celular:</label>
            <input type="text" id="celular" name="celular">
            <label for="tel-res">Telefone Residencial:</label>
            <input type="text" id="tel-res" name="tel-res">
            <label for="email">E-mail:</label>
            <input type="text" id="email" name="email" required>
            <label for="endereco">Endereço:</label>
            <input type="text" id="endereco" name="endereco" required>
            <label for="numero">Número:</label>
            <input type="text" id="numero" name="numero" required>
            <label for="complemento">Complemento:</label>
            <input type="text" id="complemento" name="complemento">
            <label for="bairro">Bairro:</label>
            <input type="text" id="bairro" name="bairro" required>
            <label for="cidade">Cidade:</label>
            <input type="text" id="cidade" name="cidade" required>
            <label for="cep">CEP:</label>
            <input type="text" id="cep" name="cep">
            <label for="uf">UF:</label>
            <input type="text" id="uf" name="uf">
            <label for="unidade">Unidade:</label>
            <input type="text" id="unidade" name="unidade">
            <label for="estado-civil">Estado Civil:</label>
            <select id="estado-civil" name="estado-civil">
                <option value="selecioneestado"> </option>
                <option value="casado">Casado</option>
                <option value="solteiro">Solteiro</option>
                <option value="uniaoestavel">União Estável</option>
                <option value="outros">Outros</option>
            <label for="nome-guerra">Nome de Guerra:</label>
            <input type="text" id="nome-guerra" name="nome-guerra">
            <label for="naturalidade">Naturalidade:</label>
            <input type="text" id="naturalidade" name="naturalidade">
            <label for="data-nasc">Data de Nascimento:</label>
            <input type="date" id="data-nasc" name="data-nasc">
            <label for="escolaridade">Escolaridade:</label>
            <input type="text" id="escolaridade" name="escolaridade">
            <label for="inicio-gcm">Início no GCM:</label>
            <input type="text" id="inicio-gcm" name="inicio-gcm">
            <label for="mae">Nome da Mãe:</label>
            <input type="text" id="mae" name="mae">
            <label for="pai">Nome do Pai:</label>
            <input type="text" id="pai" name="pai">
            <div class="dependente-container">
                <!-- (Campos dos dependentes aqui) -->
                <div class="form-row">
                    <label for="Nome_Dep_1">Nome do Dependente:</label>
                    <input type="text" id="Nome_Dep_1" name="Nome_Dep_1">
                    <label for="Parentesco_1">Parentesco:</label>
                    <select id="Parentesco_1" name="Parentesco_1">
                        <option value="selecione"> </option>
                        <option value="pai">Pai</option>
                        <option value="mae">Mãe</option>
                        <option value="conjuge">Conjuge</option>
                        <option value="filho">Filho(a)</option>
                    <label for="Nasc_1">Data de Nascimento:</label>
                    <input type="date" id="Nasc_1" name="Nasc_1">
                    <label for="Tel_Dep_1">Telefone:</label>
                    <input type="tel" id="Tel_Dep_1" name="Tel_Dep_1">
                </div>
                <div class="form-row">
                    <label for="Nome_Dep_2">Nome do Dependente:</label>
                    <input type="text" id="Nome_Dep_2" name="Nome_Dep_2">
                    <label for="Parentesco_2">Parentesco:</label>
                        <select id="Parentesco_2" name="Parentesco_2">
                        <option value="selecione"> </option>
                        <option value="pai">Pai</option>
                        <option value="mae">Mãe</option>
                        <option value="conjuge">Conjuge</option>
                        <option value="filho">Filho(a)</option>
                    <label for="Nasc_2">Data de Nascimento:</label>
                    <input type="date" id="Nasc_2" name="Nasc_2">
                    <label for="Tel_Dep_2">Telefone:</label>
                    <input type="tel" id="Tel_Dep_2" name="Tel_Dep_2">
                </div>
                <div class="form-row">
                    <label for="Nome_Dep_3">Nome do Dependente:</label>
                    <input type="text" id="Nome_Dep_3" name="Nome_Dep_3">
                    <label for="parentesco_3">Parentesco:</label>
                    <select id="Parentesco_3" name="Parentesco_3">
                        <option value="selecione"> </option>
                        <option value="pai">Pai</option>
                        <option value="mae">Mãe</option>
                        <option value="conjuge">Conjuge</option>
                        <option value="filho">Filho(a)</option>
                    <label for="Nasc_3">Data de Nascimento:</label>
                    <input type="date" id="Nasc_3" name="Nasc_3">
                    <label for="Tel_Dep_3">Telefone:</label>
                    <input type="tel" id="Tel_Dep_3" name="Tel_Dep_3">
                </div>
                <div class="form-row">
                    <label for="Nome_Dep_4">Nome do Dependente:</label>
                    <input type="text" id="Nome_Dep_4" name="Nome_Dep_4">
                    <label for="parentesco_4">Parentesco:</label>
                    <select id="Parentesco_4" name="Parentesco_4">
                        <option value="selecione"> </option>
                        <option value="pai">Pai</option>
                        <option value="mae">Mãe</option>
                        <option value="conjuge">Conjuge</option>
                        <option value="filho">Filho(a)</option>
                    <label for="Nasc_4">Data de Nascimento:</label>
                    <input type="date" id="Nasc_4" name="Nasc_4">
                    <label for="Tel_Dep_4">Telefone:</label>
                    <input type="tel" id="Tel_Dep_4" name="Tel_Dep_4">
                </div>
            </div>

            <div class="assinatura-container">
                <label for="signature">Assinatura:</label>
                <div id="signature">
                    <canvas></canvas>
                </div>
                <button type="button" onclick="clearSignature()">Limpar Assinatura</button>
            </div>

            <button type="submit" id="generatePDFButton">Gerar PDF</button>
        </form>
    </div>
    <div class="loader"></div>
    <div id="messageText"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        // Inicializar o SignaturePad
        const canvas = document.querySelector('#signature canvas');
        const signaturePad = new SignaturePad(canvas);

        function resizeCanvas() {
            const container = document.getElementById('signature');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            signaturePad.clear();
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', resizeCanvas);

        function clearSignature() {
            signaturePad.clear();
        }
                window.addEventListener('load', () => {
            Inputmask({
                mask: '999.999.999-99',
                alias: 'cpf'
            }).mask(document.getElementById('cpf'));

            Inputmask({
                mask: '(99) 99999-9999',
                alias: 'telefone'
            }).mask(document.getElementById('celular'));

            Inputmask({
                mask: '(99) 9999-9999',
                alias: 'telefone'
            }).mask(document.getElementById('tel-res'));
        });
document.getElementById('cep').addEventListener('blur', async function() {
    const cep = this.value.replace(/\D/g, ''); // Remove caracteres não numéricos

    if (cep.length === 8) { // Verifica se o CEP tem 8 dígitos
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();

            if (data.erro) {
                alert('CEP não encontrado.');
                return;
            }

            // Preenche os campos do formulário com os dados retornados pela API
            document.getElementById('endereco').value = data.logradouro;
            document.getElementById('bairro').value = data.bairro;
            document.getElementById('cidade').value = data.localidade;
            document.getElementById('uf').value = data.uf;
        } catch (error) {
            console.error('Erro ao buscar o CEP:', error);
            alert('Não foi possível buscar o endereço. Verifique sua conexão ou tente novamente.');
        }
    } else {
        alert('CEP inválido.');
    }
});


document.getElementById('generatePDFButton').addEventListener('click', async (event) => {
    event.preventDefault();
    const loader = document.querySelector('.loader');
    const messageText = document.getElementById('messageText');

loader.style.display = 'inline-block';
messageText.textContent = 'Gerando PDF...';

    document.querySelector('.loader').style.display = 'inline-block';
    document.getElementById('messageText').textContent = 'Gerando PDF...';

    try {
        const pdfBytes = await fetch('pdf/FORMULARIO_FILIACAO_ONLINE.pdf').then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        const form = pdfDoc.getForm();

        const fieldsMapping = {
            'nome': 'nome',
            'rf': 'rf',
            'cpf': 'cpf',
            'sexo': 'sexo',
            'cargo': 'cargo',
            'endereco': 'endereco',
            'numero': 'numero',
            'complemento': 'complemento',
            'bairro': 'bairro',
            'cidade': 'cidade',
            'cep': 'cep',
            'uf': 'uf',
            'unidade': 'unidade',
            'estado-civil': 'estado-civil',
            'nome-guerra': 'nome-guerra',
            'naturalidade': 'naturalidade',
            'data-nasc': 'data-nasc',
            'escolaridade': 'escolaridade',
            'inicio-gcm': 'inicio-gcm',
            'celular': 'celular',
            'tel-res': 'tel-res',
            'email': 'email',
            'mae': 'mae',
            'pai': 'pai',
            'Nome_Dep_1': 'Nome_Dep_1',
            'Nome_Dep_2': 'Nome_Dep_2',
            'Nome_Dep_3': 'Nome_Dep_3',
            'Nome_Dep_4': 'Nome_Dep_4',
            'Parentesco_1': 'Parentesco_1',
            'Parentesco_2': 'Parentesco_2',
            'Parentesco_3': 'Parentesco_3',
            'Parentesco_4': 'Parentesco_4',
            'Nasc_1': 'Nasc_1',
            'Nasc_2': 'Nasc_2',
            'Nasc_3': 'Nasc_3',
            'Nasc_4': 'Nasc_4',
            'Tel_Dep_1': 'Tel_Dep_1',
            'Tel_Dep_2': 'Tel_Dep_2',
            'Tel_Dep_3': 'Tel_Dep_3',
            'Tel_Dep_4': 'Tel_Dep_4'
        };

        for (const [pdfField, htmlField] of Object.entries(fieldsMapping)) {
            const value = document.getElementById(htmlField)?.value || '';
            if (form.getTextField(pdfField)) {
                form.getTextField(pdfField).setText(value);
            }
        }

        // Função para obter o nome do mês por extenso em português
        function mesPorExtenso(mes) {
            const meses = [
                'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
                'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
            ];
            return meses[mes - 1]; // Ajusta o índice, já que meses começam do 1
        }

        // Adiciona a data atual aos campos específicos
        const today = new Date();
        const day = today.getDate();
        const month = today.getMonth() + 1; // O mês começa do 0 em JavaScript, então adicionamos 1
        const year = today.getFullYear();

        // Atualize os campos de data no PDF
        const dayField = form.getTextField('dia');
        if (dayField) dayField.setText(day.toString());

        const monthField = form.getTextField('mes');
        if (monthField) monthField.setText(mesPorExtenso(month)); // Usa a função mesPorExtenso para obter o nome do mês

        const yearField = form.getTextField('ano');
        if (yearField) yearField.setText(year.toString());

        if (signaturePad.isEmpty()) {
            alert('A assinatura é obrigatória.');
            return;
        }

        const signatureImage = signaturePad.toDataURL('image/png');
        const image = await pdfDoc.embedPng(signatureImage);

        const signatureWidth = 150; // Defina a largura desejada
        const signatureHeight = 50; // Defina a altura desejada
        const firstPage = pdfDoc.getPage(0); // Obter a primeira página do documento

        firstPage.drawImage(image, {
            x: 80,
            y: 90,
            width: signatureWidth,
            height: signatureHeight
        });

        const pdfBytesUpdated = await pdfDoc.save();
        const blob = new Blob([pdfBytesUpdated], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);

        // Captura o nome do usuário e cria o nome do arquivo
        const nome = document.getElementById('nome')?.value || 'Formulario_Filiacao_Online';
        const safeNome = nome.replace(/[<>:"/\\|?*]/g, ''); // Remove caracteres inválidos para nome de arquivo
        const fileName = `Ficha de Filiação - ${safeNome}.pdf`;
        link.download = fileName; // Usa o nome capturado para o arquivo

        link.click();

        loader.style.display = 'none';
        messageText.textContent = 'PDF gerado com sucesso!';

        // Limpar o formulário
        document.getElementById('expenseForm').reset();

        // Limpar a assinatura
        signaturePad.clear();

        document.getElementById('messageText').textContent = 'PDF gerado com sucesso!';
    } catch (error) {
        console.error('Erro ao gerar o PDF:', error);
        document.getElementById('messageText').textContent = 'Erro ao gerar o PDF.';
    } finally {
        document.querySelector('.loader').style.display = 'none';
    }
});
    </script>
</body>
</html>
